# 測試二 - 多用戶並發測試功能說明

## 功能概述

測試二是一個專門設計的多用戶並發測試功能，用於模擬真實環境中多個用戶同時使用不同提示詞查詢同一個Ollama模型的場景。主要目的是測試模型的TPM (Tokens Per Minute) 性能和並發處理能力。

## 核心特性

### 🎯 測試目標
- **TPM性能測試**: 計算每分鐘回傳的Token數量
- **並發能力評估**: 測試模型在多用戶同時查詢時的表現
- **真實場景模擬**: 每個用戶使用不同的提示詞，更貼近實際使用情況

### 📊 測試配置
- **用戶數量**: 1-10個模擬用戶（下拉式選單選擇）
- **查詢次數**: 每個用戶可執行的查詢次數（可自定義）
- **並發控制**: 最大並發限制，避免系統過載
- **查詢間隔**: 控制查詢頻率，模擬真實使用節奏

### 💬 提示詞系統
- **內建提示詞庫**: 50組精心準備的常用詢問句
  - 基礎問答類 (10組)
  - 技術解釋類 (10組)
  - 生活應用類 (10組)
  - 知識問答類 (10組)
  - 創意思考類 (10組)
- **隨機分配**: 每個用戶自動獲得不同的提示詞組合
- **自定義選項**: 支援使用者自定義提示詞集

## 使用方法

### 1. 基本配置
1. 選擇要測試的Ollama模型
2. 設定模擬用戶數量 (建議從2個用戶開始)
3. 設定每個用戶的查詢次數
4. 調整並發限制和查詢間隔

### 2. 提示詞設定
- **推薦**: 選擇「使用內建50組隨機提示詞」
- **進階**: 選擇「使用自定義提示詞」並輸入自己的提示詞

### 3. 監控選項
- **TPM監控**: 啟用每分鐘Token數量統計
- **詳細日誌**: 記錄詳細的測試過程

### 4. 執行測試
1. 點擊「開始多用戶測試」
2. 觀察實時進度和TPM統計
3. 等待測試完成並查看結果

## 測試結果

### 📈 統計指標
- **總查詢數**: 所有用戶執行的查詢總數
- **成功查詢數**: 成功完成的查詢數量
- **成功率**: 成功查詢的百分比
- **總Token數**: 所有成功查詢回傳的Token總數
- **平均TPM**: 平均每分鐘Token數量
- **峰值TPM**: 測試期間的最高TPM值
- **平均響應時間**: 所有查詢的平均響應時間

### 📊 實時監控
- 測試進度百分比
- 當前TPM值
- 活躍用戶數
- 即時日誌更新

## 技術實現

### 後端架構
- **多線程並發**: 使用ThreadPoolExecutor實現真正的並發查詢
- **任務隊列**: 管理所有查詢任務的執行順序
- **狀態追蹤**: 實時追蹤每個用戶的查詢狀態
- **TPM計算**: 基於時間窗口的Token統計算法

### 前端交互
- **AJAX輪詢**: 每2秒更新一次測試狀態
- **實時進度**: 動態更新進度條和統計信息
- **配置預覽**: 友好的配置預覽界面
- **錯誤處理**: 完善的錯誤提示和恢復機制

## API端點

### 啟動測試
```
POST /api/start_multi_user_test
```

### 查詢狀態
```
GET /api/multi_user_test_status/<test_id>
```

### 停止測試
```
POST /api/stop_multi_user_test
```

## 使用建議

### 🚀 初次使用
1. 選擇較小的模型（如llama3:8b）
2. 從2個用戶、每用戶3次查詢開始
3. 使用內建隨機提示詞
4. 觀察系統資源使用情況

### ⚡ 性能優化
1. 根據硬體配置調整並發限制
2. 適當設定查詢間隔避免過載
3. 監控GPU/CPU使用率
4. 逐步增加用戶數量測試極限

### 📋 測試場景
- **基準測試**: 單用戶 vs 多用戶性能對比
- **負載測試**: 逐步增加用戶數量找出性能瓶頸
- **穩定性測試**: 長時間運行測試系統穩定性
- **模型對比**: 不同模型在相同條件下的TPM表現

## 注意事項

### ⚠️ 系統要求
- 確保Ollama服務器正常運行
- 有足夠的系統資源（RAM/GPU）
- 穩定的網路連接

### 🔧 故障排除
- 如果查詢失敗，檢查模型是否正確載入
- 如果TPM為0，確認模型能正常回應
- 如果測試卡住，可能是並發數設定過高

### 💡 最佳實踐
- 測試前先用測試一驗證模型可用性
- 從小規模測試開始，逐步擴大
- 記錄不同配置下的測試結果
- 定期清理日誌避免界面過於擁擠

## 文件結構

```
├── multi_user_test_config.py      # 數據結構和配置
├── multi_user_stress_test.py      # 核心測試邏輯
├── templates/index.html            # 前端界面
├── static/js/app_simple.js        # JavaScript交互
├── app.py                          # Flask API端點
├── demo_multi_user_test.py         # 演示腳本
└── TEST2_README.md                 # 本說明文件
```

## 更新日誌

### v1.0.0 (2025-01-11)
- ✅ 實現多用戶並發測試核心功能
- ✅ 內建50組常用提示詞庫
- ✅ TPM計算和實時監控
- ✅ 友好的Web界面
- ✅ 完整的API支持
- ✅ 詳細的統計報告
